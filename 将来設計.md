# 万博待ち時間BIダッシュボード開発：設計指示書

## 📌 目的

万博の各パビリオンにおける**待ち時間を曜日・時間帯・形式別に可視化**し、傾向分析・混雑予測に活用できるダッシュボードを構築する。

---

## 🏗 システム構成概要

```
+--------------------+        +-------------------+        +----------------------+
| 待ち時間データ取得 |  →     | ETL (整形・加工)  |  →     |   分析用DB (SQLite)   |
| (Pythonスクリプト) |        |   (pandas/sql)    |        |                      |
+--------------------+        +-------------------+        +----------------------+
                                                              ↓
                                                +-----------------------------+
                                                | Dash ダッシュボード         |
                                                | - 複雑なフィルタ機能        |
                                                | - ヒートマップ/折れ線/表表示|
                                                +-----------------------------+
```

---

## ⚙️ 使用技術

| レイヤ   | 技術                                        | 理由・役割                |
| ----- | ----------------------------------------- | -------------------- |
| データ取得 | Python（cron or GitHub Actions）            | 毎時の待ち時間データを自動収集      |
| データ保存 | SQLite                                    | 軽量・無料・ファイルベースで管理しやすい |
| データ加工 | pandas / SQLAlchemy                       | フィルタ設計に必要な時間帯/形式等の加工 |
| 可視化   | Dash + Plotly + dash-bootstrap-components | UIの柔軟性・複雑フィルタに対応     |
| CI/CD | GitHub / GitHub Actions                   | スクリプト管理・定期実行・デプロイ自動化 |

---

## 🧱 データ構造（初期）

### `wait_times`（待ち時間データ）

| カラム名            | 型        | 説明                       |
| --------------- | -------- | ------------------------ |
| `id`            | INTEGER  | 主キー                      |
| `timestamp`     | DATETIME | データ取得時刻                  |
| `pavilion_name` | TEXT     | パビリオン名                   |
| `area`          | TEXT     | エリア分類（例：エリアA）            |
| `format`        | TEXT     | 入場形式（自由／ツアー）             |
| `duration`      | INTEGER  | 所要時間（目安、分）               |
| `wait_time`     | TEXT     | 待ち時間（例："60分以上前", "情報なし"） |

→ ETLで以下の属性を付加：

* `weekday`: 曜日（文字列）
* `hour_range`: 時間帯（例：09:00〜10:00）

---

## 🎨 ダッシュボード構成（画面設計）

### サイドバー：フィルタ項目

* `エリア`：Dropdown（複数選択可）
* `形式`：Checklist（自由／ツアーなど）
* `所要時間`: RangeSlider（例：0〜60分）
* `曜日`: Checklist（月〜日）
* `時間帯`: Checklist（午前／午後／夕方）

### メインビュー：可視化内容

1. 📊 **ヒートマップ**（曜日 × 時間帯 × 平均待ち時間）
2. 📈 **折れ線グラフ**（時間帯別の推移）
3. 📋 **詳細表（DataTable）**（パビリオン別にフィルタ結果を一覧表示）

---

## 🔁 ワークフロー例（定期実行）

1. **毎時**：

   * スクレイピング／APIで最新待ち時間データを取得し、`wait_times` テーブルに追加
   * `etl.py` を実行して分析用テーブルへ整形・保存

2. **常時**：

   * Dashアプリは `app.py` でホストされ、ユーザーはフィルタを操作して分析可能

3. **定期ジョブ設定**：

   * GitHub Actions（またはcron）でETL＋アプリ再起動を自動化

---

## 📁 推奨ディレクトリ構成

```
project-root/
├── data/
│   └── wait_times.db
├── etl/
│   └── etl.py
├── dash_app/
│   ├── app.py
│   ├── layout.py
│   ├── callbacks.py
│   ├── components/
│   │   ├── sidebar.py
│   │   └── charts.py
│   └── assets/
│       └── custom.css
├── scripts/
│   └── fetch_data.py
├── .github/workflows/
│   └── update.yml
└── README.md
```

---

## ✅ ToDo（初期開発タスク）

1. [ ] `fetch_data.py`：待ち時間取得の自動化スクリプト作成
2. [ ] `etl.py`：曜日・時間帯など分析に必要な列を追加・整形
3. [ ] `dash_app/`：Dash構成の初期スケルトン作成（サイドバー＋ヒートマップ）
4. [ ] `update.yml`：GitHub Actions で定期実行できる構成を設定
5. [ ] `README.md`：開発／運用手順をドキュメント化

---

## 📌 注意点

* **フィルタの組合せが増えると、グラフの更新処理が重くなる可能性がある** → `@callback` 内で効率よく抽出・キャッシュ対応する
* **“情報なし”などの欠損データの扱い**は、分析観点に応じて事前にETLで整形しておく
* **グラフライブラリの統一**（Plotly中心）により、インタラクティブ性と再利用性を高める

